{% extends "base.html" %}

{% block title %}Tasks - Todo CLI{% endblock %}

{% block content %}
<div class="main-content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 class="main-content-title">Tasks</h1>
            <p class="main-content-subtitle">Manage your todo items</p>
        </div>
        <button class="btn btn-primary" onclick="showCreateTaskModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Task
        </button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-search">
        <input 
            type="text" 
            class="input" 
            placeholder="Search tasks..." 
            id="searchInput"
            onkeyup="filterTasks()"
        >
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Status</label>
        <select class="select filter-select" id="statusFilter" onchange="filterTasks()">
            <option value="all">All</option>
            <option value="active">Active</option>
            <option value="completed">Completed</option>
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Priority</label>
        <select class="select filter-select" id="priorityFilter" onchange="filterTasks()">
            <option value="all">All</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Project</label>
        <select class="select filter-select" id="projectFilter" onchange="filterTasks()">
            <option value="all">All Projects</option>
            {% for project in projects %}
            <option value="{{ project.id }}">{{ project.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <button class="btn btn-ghost btn-sm" onclick="clearFilters()">
        Clear Filters
    </button>
</div>

<!-- Active Filters -->
<div id="activeFilters" class="filter-chips" style="padding: var(--space-4); display: none;">
    <!-- Filter chips will be added dynamically -->
</div>

<!-- Split Pane Layout -->
<div class="split-pane" x-data="{ 
    selectedTask: null,
    splitWidth: 60 
}">
    <!-- Task List -->
    <div class="split-pane-left" :style="`flex: ${splitWidth}`">
        <div id="taskList" class="task-list" style="padding: var(--space-4);">
            {% if tasks %}
                {% for task in tasks %}
                <div class="task-item {% if task.completed %}completed{% endif %}" 
                     data-task-id="{{ task.id }}"
                     data-status="{{ 'completed' if task.completed else 'active' }}"
                     data-priority="{{ task.priority or 'none' }}"
                     data-project="{{ task.project_id or 'none' }}"
                     @click="selectedTask = '{{ task.id }}'">
                    
                    <div class="task-checkbox {% if task.completed %}checked{% endif %}" 
                         onclick="event.stopPropagation(); toggleTask('{{ task.id }}')">
                    </div>
                    
                    <div class="task-content">
                        <div class="task-title">{{ task.title }}</div>
                        
                        {% if task.description %}
                        <div class="task-description">
                            {{ task.description[:80] }}{% if task.description|length > 80 %}...{% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="task-meta">
                            {% if task.priority %}
                            <span class="task-priority {{ task.priority }}">
                                {{ task.priority|upper }}
                            </span>
                            {% endif %}
                            
                            {% if task.due_date %}
                            <span class="task-due-date {% if task.is_overdue %}overdue{% elif task.is_today %}today{% endif %}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                {{ task.due_date.strftime('%b %d, %Y') }}
                            </span>
                            {% endif %}
                            
                            {% if task.project %}
                            <span class="task-project">{{ task.project.name }}</span>
                            {% endif %}
                            
                            {% if task.tags %}
                            <div class="task-tags">
                                {% for tag in task.tags[:3] %}
                                <span class="task-tag">{{ tag }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="task-actions">
                        <button class="btn btn-ghost btn-sm btn-icon" 
                                onclick="event.stopPropagation(); editTask('{{ task.id }}')" 
                                title="Edit">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn btn-ghost btn-sm btn-icon" 
                                onclick="event.stopPropagation(); deleteTask('{{ task.id }}')" 
                                title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"></path>
                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                </svg>
                <div class="empty-state-title">No tasks found</div>
                <div class="empty-state-message">Create your first task to get started!</div>
                <button class="btn btn-primary" onclick="showCreateTaskModal()">
                    Create Task
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Resizable Divider -->
    <div class="split-pane-divider" x-show="selectedTask"></div>
    
    <!-- Task Detail Panel -->
    <div class="split-pane-right" 
         x-show="selectedTask" 
         x-transition
         :style="`flex: ${100 - splitWidth}`">
        <div class="task-detail" id="taskDetail">
            <div class="task-detail-header">
                <div class="task-detail-title-group">
                    <h2 class="task-detail-title">Task Details</h2>
                </div>
                <button class="btn btn-ghost btn-icon" @click="selectedTask = null">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="task-detail-body" id="taskDetailContent">
                <!-- Task details will be loaded dynamically -->
                <div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted);">
                    Select a task to view details
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Task Modal -->
<div id="taskModal" style="display: none;">
    <div class="modal-backdrop" onclick="closeTaskModal()"></div>
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Create Task</h2>
            <button class="btn btn-ghost btn-icon" onclick="closeTaskModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <form id="taskForm" onsubmit="submitTask(event)">
            <div class="modal-body">
                <input type="hidden" id="taskId" name="id">
                
                <div class="form-field">
                    <label for="taskTitle" class="form-label">Title *</label>
                    <input 
                        type="text" 
                        id="taskTitle" 
                        name="title" 
                        class="input" 
                        placeholder="Task title"
                        required
                        autofocus
                    >
                </div>
                
                <div class="form-field">
                    <label for="taskDescription" class="form-label">Description</label>
                    <textarea 
                        id="taskDescription" 
                        name="description" 
                        class="textarea" 
                        placeholder="Add details about this task..."
                    ></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                    <div class="form-field">
                        <label for="taskPriority" class="form-label">Priority</label>
                        <select id="taskPriority" name="priority" class="select">
                            <option value="">None</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label for="taskDueDate" class="form-label">Due Date</label>
                        <input 
                            type="date" 
                            id="taskDueDate" 
                            name="due_date" 
                            class="input"
                        >
                    </div>
                </div>
                
                <div class="form-field">
                    <label for="taskProject" class="form-label">Project</label>
                    <select id="taskProject" name="project_id" class="select">
                        <option value="">None</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="taskTags" class="form-label">Tags</label>
                    <input 
                        type="text" 
                        id="taskTags" 
                        name="tags" 
                        class="input" 
                        placeholder="Separate tags with commas"
                    >
                    <span class="form-hint">Example: work, urgent, meeting</span>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeTaskModal()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Save Task
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Task filtering
    function filterTasks() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const priority = document.getElementById('priorityFilter').value;
        const project = document.getElementById('projectFilter').value;
        
        const tasks = document.querySelectorAll('.task-item');
        let visibleCount = 0;
        
        tasks.forEach(task => {
            const title = task.querySelector('.task-title').textContent.toLowerCase();
            const taskStatus = task.dataset.status;
            const taskPriority = task.dataset.priority;
            const taskProject = task.dataset.project;
            
            const matchesSearch = title.includes(search);
            const matchesStatus = status === 'all' || status === taskStatus;
            const matchesPriority = priority === 'all' || priority === taskPriority;
            const matchesProject = project === 'all' || project === taskProject;
            
            if (matchesSearch && matchesStatus && matchesPriority && matchesProject) {
                task.style.display = '';
                visibleCount++;
            } else {
                task.style.display = 'none';
            }
        });
        
        updateActiveFilters();
    }
    
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('priorityFilter').value = 'all';
        document.getElementById('projectFilter').value = 'all';
        filterTasks();
    }
    
    function updateActiveFilters() {
        // Update active filter chips display
        const container = document.getElementById('activeFilters');
        const hasFilters = document.getElementById('searchInput').value ||
                          document.getElementById('statusFilter').value !== 'all' ||
                          document.getElementById('priorityFilter').value !== 'all' ||
                          document.getElementById('projectFilter').value !== 'all';
        
        container.style.display = hasFilters ? 'flex' : 'none';
    }
    
    // Task operations
    function toggleTask(taskId) {
        fetch(`/api/tasks/${taskId}/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    function deleteTask(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) return;
        
        fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Modal operations
    function showCreateTaskModal() {
        document.getElementById('modalTitle').textContent = 'Create Task';
        document.getElementById('taskForm').reset();
        document.getElementById('taskId').value = '';
        document.getElementById('taskModal').style.display = 'block';
    }
    
    function editTask(taskId) {
        fetch(`/api/tasks/${taskId}`)
            .then(response => response.json())
            .then(task => {
                document.getElementById('modalTitle').textContent = 'Edit Task';
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskPriority').value = task.priority || '';
                document.getElementById('taskDueDate').value = task.due_date || '';
                document.getElementById('taskProject').value = task.project_id || '';
                document.getElementById('taskTags').value = task.tags ? task.tags.join(', ') : '';
                document.getElementById('taskModal').style.display = 'block';
            })
            .catch(error => console.error('Error:', error));
    }
    
    function closeTaskModal() {
        document.getElementById('taskModal').style.display = 'none';
    }
    
    function submitTask(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const taskId = formData.get('id');
        const method = taskId ? 'PUT' : 'POST';
        const url = taskId ? `/api/tasks/${taskId}` : '/api/tasks';
        
        const data = {
            title: formData.get('title'),
            description: formData.get('description'),
            priority: formData.get('priority'),
            due_date: formData.get('due_date'),
            project_id: formData.get('project_id'),
            tags: formData.get('tags').split(',').map(t => t.trim()).filter(t => t)
        };
        
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeTaskModal();
        }
    });
</script>
{% endblock %}
